#!/usr/bin/env python3

import argparse
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import scanpy as sc
import squidpy as sq


def main(args):
    ##########################################################
    ## MORAN'S I GLOBAL SPATIAL AUTO-CORRELATION STATISTICS ##
    ##########################################################
    adata = sc.read_h5ad(args.adata_input)

    genes = adata.var_names[adata.var["highly_variable"]].tolist()

    # Check spots per slide
    spots_per_slide = adata.obs["visium_slide_ref"].value_counts()
    print("Spots per slide:")
    print(spots_per_slide)
    slides_to_keep = spots_per_slide[spots_per_slide >= 4].index.tolist()
    adata_filtered = adata[adata.obs["visium_slide_ref"].isin(slides_to_keep)].copy()

    # Remove NaNs
    nan_mask = np.isnan(adata_filtered.obsm["spatial"]).any(axis=1)
    if nan_mask.any():
        n_nan = nan_mask.sum()
        adata_filtered = adata_filtered[~nan_mask].copy()
        print(f"Removed {n_nan} observations with NaN coordinates ({adata_filtered.shape[0]} remaining)")

    sq.gr.spatial_neighbors(
        adata_filtered,
        library_key="visium_slide_ref",
        coord_type="generic",
        delaunay=True,
    )
    sq.gr.spatial_autocorr(
        adata_filtered,
        mode="moran",
        genes=genes,
        n_perms=100,
        n_jobs=1,
    )
    top_10_variable_genes = adata_filtered.uns["moranI"].head(10)

    top_4_variable_gene_list = adata_filtered.uns["moranI"].head(4).index.tolist()
    slides = adata_filtered.obs["visium_slide_ref"].unique().tolist()
    titles = [f"{slide} - {color}" for slide in slides for color in top_4_variable_gene_list]

    # Clean up
    present_slides = adata_filtered.obs["visium_slide_ref"].unique()
    all_slides = list(adata_filtered.uns["spatial"].keys())
    for slide in all_slides:
        if slide not in present_slides:
            del adata_filtered.uns["spatial"][slide]
            
    sq.pl.spatial_scatter(
        adata_filtered,
        library_key="visium_slide_ref",
        color=top_4_variable_gene_list,
        title=titles,
    )
    plt.savefig(f"{args.cohort_id}.moran_top_4_variable_genes_spatial_scatter.png", dpi=300, bbox_inches="tight")

    # Save table and adata object
    top_10_variable_genes.to_csv(f"{args.cohort_id}.moran_top_10_variable_genes.csv")
    metadata = adata_filtered.obs
    metadata.to_csv(f"{args.cohort_id}.final_metadata.csv")
    adata_filtered.write_h5ad(filename=args.adata_output, compression="gzip")


if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        description="Identify spatially variable genes by computing Moran's I Score"
    )
    parser.add_argument(
        "-c",
        "--cohort-id",
        type=str,
        required=True,
        help="Cohort ID"
    )
    parser.add_argument(
        "-i",
        "--adata-input",
        type=str,
        required=True,
        help="Adata object to compute Moran's I Score on"
    )
    parser.add_argument(
        "-o",
        "--adata-output",
        type=str,
        required=True,
        help="Output file name for the spatial auto-correction AnnData object"
    )

    args = parser.parse_args()

    main(args)
